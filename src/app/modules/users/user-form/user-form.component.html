<h2>{{ userId ? 'Editar Usuario' : 'Nuevo Usuario' }}</h2>

<form #userForm="ngForm" (ngSubmit)="saveUser(userForm)" novalidate>

  <!-- Nombre -->
  <mat-form-field appearance="fill">
    <mat-label>Nombre</mat-label>
    <input matInput [(ngModel)]="userData.name" name="name" required #name="ngModel">
    <mat-error *ngIf="name.invalid && name.touched">El nombre es obligatorio</mat-error>
  </mat-form-field>

  <!-- Apellido -->
  <mat-form-field appearance="fill">
    <mat-label>Apellido</mat-label>
    <input matInput [(ngModel)]="userData.lastname" name="lastname" required #lastname="ngModel">
    <mat-error *ngIf="lastname.invalid && lastname.touched">El apellido es obligatorio</mat-error>
  </mat-form-field>

  <!-- Email -->
  <mat-form-field appearance="fill">
    <mat-label>Email</mat-label>
    <input matInput 
           [(ngModel)]="userData.email" 
           name="email" 
           required 
           type="email" 
           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
           #email="ngModel">
    <mat-error *ngIf="email.invalid && email.touched">
      <span *ngIf="email.errors?.['required']">El email es obligatorio</span>
      <span *ngIf="email.errors?.['pattern']">Ingresa un email válido (ej: usuario&#64;dominio.com)</span>
    </mat-error>
  </mat-form-field>

  <!-- Contraseña -->
  <mat-form-field *ngIf="!userId" appearance="fill">
    <mat-label>Contraseña</mat-label>
    <input matInput 
           [(ngModel)]="userData.password" 
           name="password" 
           [type]="hidePassword ? 'password' : 'text'" 
           required minlength="6" 
           #password="ngModel">
    <button mat-icon-button matSuffix type="button" (click)="hidePassword = !hidePassword">
      <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
    </button>
    <mat-error *ngIf="password.invalid && password.touched">
      <span *ngIf="password.errors?.['required']">La contraseña es obligatoria</span>
      <span *ngIf="password.errors?.['minlength']">Mínimo 6 caracteres</span>
    </mat-error>
  </mat-form-field>

  <!-- Rol -->
  <mat-form-field appearance="fill">
    <mat-label>Rol</mat-label>
    <mat-select [(ngModel)]="userData.rol" name="rol" required #rol="ngModel">
      <mat-option *ngFor="let r of roles" [value]="r">{{ r }}</mat-option>
    </mat-select>
    <mat-error *ngIf="rol.invalid && rol.touched">Selecciona un rol</mat-error>
  </mat-form-field>

  <!-- Empresa -->
<mat-form-field appearance="fill">
    <mat-label>Empresa</mat-label>
    <mat-select [(ngModel)]="userData.empresaId" 
                name="empresaId" 
                required 
                #empresa="ngModel"
                [disabled]="userData.rol === 'admin_empresa'">
      <mat-option *ngFor="let e of empresas" [value]="e.id">{{ e.Nombre || e.nombre }}</mat-option>
    </mat-select>
    <mat-error *ngIf="empresa.invalid && empresa.touched">Selecciona una empresa</mat-error>
  </mat-form-field>

  <!-- Botones -->
  <div class="buttons">
    <button mat-raised-button color="primary" type="submit" [disabled]="userForm.invalid">
      {{ userId ? 'Actualizar' : 'Crear' }}
    </button>
    <button mat-raised-button color="warn" type="button" (click)="cancel()">Cancelar</button>
  </div>

</form>
